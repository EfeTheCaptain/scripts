#!/usr/bin/env bash

DISKS=("/" "/home")
ICONS=(" " " ")
DISKS_FILE="/tmp/dwmblocks_disk_info"

# Pre-calculate array length
DISKS_LEN=${#DISKS[@]}

# Read INDEX and FORMAT from file
read INDEX FORMAT < "$DISKS_FILE" 2>/dev/null || { INDEX=0; FORMAT=0; }

# Validate INDEX and FORMAT
if (( INDEX < 0 || INDEX >= DISKS_LEN )); then INDEX=0; fi
if (( FORMAT != 0 && FORMAT != 1 )); then FORMAT=0; fi

CURRENT_DISK="${DISKS[$INDEX]}"
ICON="${ICONS[$INDEX]}"

# Single df call and parse with read
if IFS=' ' read -r _ _ _ SPACE PERCENT _ <<< "$(df -h "$CURRENT_DISK" 2>/dev/null | awk 'NR==2 {print $1,$2,$3,$4,$5,$6}')"; then
    if (( FORMAT == 0 )); then
        INFO="$PERCENT"
    else
        INFO="$SPACE"
    fi
else
    INFO="Error"
fi

case $BLOCK_BUTTON in
    1) let "INDEX=(INDEX + 1) % DISKS_LEN" ; echo "$INDEX $FORMAT" > "$DISKS_FILE" ;;
    3) let "INDEX=(INDEX - 1) % DISKS_LEN" ; echo "$INDEX $FORMAT" > "$DISKS_FILE" ;;
    2) let "FORMAT=(FORMAT + 1) % 2" ; echo "$INDEX $FORMAT" > "$DISKS_FILE" ;;
    6) st -e nvim "$0" ;;
esac

echo "$ICON$INFO"
