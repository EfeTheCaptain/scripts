get_video_url() {
  local query="$1"

  # Get video results from yt-dlp
  local results
  results=$(yt-dlp -j --flat-playlist "ytsearch$search_size:$query" 2>/dev/null)
  echo "yt-dlp results:"
  echo "$results"

  # Check if results are empty or invalid JSON
  if [[ -z "$results" ]]; then
    echo "No videos found." >&2
    return 1
  fi

  # Check if the output is a JSON array.
  if [[ "$(echo "$results" | jq -e 'if type == "array" then exit(0) else exit(1) end')" -ne 0 ]]; then
      echo "yt-dlp returned non-array JSON." >&2
      return 1
  fi

  # Extract title and URL from results
  local titles
  titles=$(echo "$results" | jq -r '.[] | .title + " (" + .id + ")"')

  # Select video using fzf
  local selection
  selection=$(echo "$titles" | fzf --height "40%" --reverse --header "Select video")
  echo "fzf selection:"
  echo "$selection"

  # Check if a selection was made
  if [[ -z "$selection" ]]; then
    echo "No video selected." >&2
    return 1
  fi

  # Extract URL from results
  local index
  index=$(echo "$titles" | grep -n "$selection" | cut -d: -f1)
  url=$(echo "$results" | jq -r ".[$((index-1))].url")
  echo "Selected URL:"
  echo "$url"

  echo "$url"
  return 0
}
