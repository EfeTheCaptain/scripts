calculate_estimate() {
    if [ ! -f "$DATA_FILE" ]; then
        echo "No data available."
        return
    fi
    
    local current_time=$(get_timestamp)
    local current_percentage=$(get_battery_percentage)
    local acpi_remaining_minutes=$(get_acpi_remaining_minutes)
    
    local short_term_rate=0.0
    local short_term_percentage_change=0.0
    local short_term_elapsed_time=0
    local prev_timestamp=""
    local prev_percentage=""
    
    while IFS=',' read -r timestamp percentage; do
        if [ -n "$prev_timestamp" ] && [ "$percentage" != "N/A" ] && [ "$prev_percentage" != "N/A" ]; then
            local elapsed_time=$((timestamp - prev_timestamp))
            local percentage_change=$((prev_percentage - percentage))
            
            if [ "$elapsed_time" -gt 0 ] && [ "$percentage_change" -gt 0 ] && [ $((current_time - timestamp)) -le $SHORT_TERM_WINDOW ]; then
                short_term_rate=$(echo "scale=4; $percentage_change / $elapsed_time" | bc)
                short_term_percentage_change=$percentage_change
                short_term_elapsed_time=$((current_time - timestamp))
            fi
        fi
        prev_timestamp=$timestamp
        prev_percentage=$percentage
    done < "$DATA_FILE"

    if [ "$current_percentage" != "N/A" ] && [ "$(echo "$short_term_rate > 0" | bc -l)" -eq 1 ] && [ "$acpi_remaining_minutes" != "N/A" ]; then
        local short_term_remaining_minutes=$(echo "scale=0; $current_percentage / $short_term_rate / 60" | bc)
        local experienced_weight=$(echo "scale=4; (100 - $ACPI_WEIGHT * 100) / 100" | bc)
        local combined_remaining_minutes=$(echo "scale=0; ($short_term_remaining_minutes * $experienced_weight) + ($acpi_remaining_minutes * $ACPI_WEIGHT)" | bc)
        local remaining_hours=$((combined_remaining_minutes / 60))
        local remaining_minutes=$((combined_remaining_minutes % 60))
        
        if is_charging; then
            echo "Battery is charging."
        else
            echo "Estimated remaining time: $remaining_hours hours and $remaining_minutes minutes"
            printf "%s,%s,%s\n" "$current_time" "$current_percentage" "$combined_remaining_minutes" >> "$HOME/estimation_data.csv"
        fi
    else
        if [ "$acpi_remaining_minutes" != "N/A" ] && is_charging; then
            echo "Battery is charging."
        elif [ "$acpi_remaining_minutes" != "N/A" ]; then
            echo "Estimated remaining time: $(($acpi_remaining_minutes / 60)) hours and $(($acpi_remaining_minutes % 60)) minutes (ACPI based)"
        else
            echo "Unable to calculate remaining time."
        fi
    fi
}
